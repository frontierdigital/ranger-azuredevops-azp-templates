---
parameters:
  - name: configRef
    type: string
  - name: deployJobs
    type: jobList
    default: []
  - name: deploySteps
    type: stepList
    default: []
  - name: environment
    type: string
  - name: installSteps
    type: stepList
    default: []
  - name: organisationName
    type: string
  - name: serviceConnectionName
    type: string
  - name: stageName
    type: string
    default: Deploy
  - name: workloadFeedName
    type: string

stages:
  - stage: ${{ parameters.stageName }}
    pool:
      vmImage: ubuntu-latest
    jobs:
      - deployment: DeployFromPipelineArtifact
        displayName: Deploy workload package
        environment:
          name: ${{ parameters.environment }}
        strategy:
          runOnce:
            deploy:
              steps:
                - download: none
                - checkout: none
                - template: ../steps/clear-default-working-directory.yml
                - template: ../steps/download-workload-package.yml
                  parameters:
                    feedName: ${{ parameters.workloadFeedName }}
                    version: $(Build.SourceBranchName)
                - ${{ parameters.installSteps }}
                - ${{ if not(eq(parameters.configRef, 'null')) }}:
                    - template: ../steps/fetch-config-and-secrets.yml
                      parameters:
                        organisationName: ${{ parameters.organisationName }}
                        ref: ${{ parameters.configRef }}
                        serviceConnectionName: ${{ parameters.serviceConnectionName }}
                - ${{ parameters.deploySteps }}
      - ${{ parameters.deployJobs }}
