---
parameters:
  - name: configRef
    type: string
  - name: destroySteps
    type: stepList
    default: []
  - name: environment
    type: string
  - name: installSteps
    type: stepList
    default: []
  - name: organisationName
    type: string
  - name: pool
    type: object
  - name: serviceConnectionName
    type: string
  - name: timeoutInMinutes
    type: number
    default: 60
  - name: workloadFeedName
    type: string

stages:
  - stage: Destroy
    pool: ${{ parameters.pool }}
    jobs:
      - deployment: DestroyFromPipelineArtifact
        displayName: Destroy workload package
        timeoutInMinutes: ${{ parameters.timeoutInMinutes }}
        environment:
          name: ${{ parameters.environment }}
        strategy:
          runOnce:
            deploy:
              steps:
                - download: none
                - checkout: none
                - template: ../steps/clear-default-working-directory.yml
                - template: ../steps/download-workload-package.yml
                  parameters:
                    feedName: ${{ parameters.workloadFeedName }}
                    version: $(Build.SourceBranchName)
                - ${{ parameters.installSteps }}
                - ${{ if not(eq(parameters.configRef, 'null')) }}:
                    - template: ../steps/fetch-config-and-secrets.yml
                      parameters:
                        organisationName: ${{ parameters.organisationName }}
                        ref: ${{ parameters.configRef }}
                        serviceConnectionName: ${{ parameters.serviceConnectionName }}
                - ${{ parameters.destroySteps }}
